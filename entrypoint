#!/bin/sh

# Unbuffer Python everywhere
export PYTHONUNBUFFERED=1

python3 -u scheduler.py &
SCHEDULER_PID=$!

kopf run --standalone --liveness=http://0.0.0.0:8080/healthz main.py &
KOPF_PID=$!

# Clean shutdown
trap "kill $SCHEDULER_PID $KOPF_PID 2>/dev/null || true" INT TERM
if wait -n 2>/dev/null; then
  wait -n "$SCHEDULER_PID" "$KOPF_PID"
else
  while kill -0 "$SCHEDULER_PID" 2>/dev/null && kill -0 "$KOPF_PID" 2>/dev/null; do
    sleep 1
  done
fi

kill "$SCHEDULER_PID" "$KOPF_PID" 2>/dev/null || true
wait "$SCHEDULER_PID" 2>/dev/null || true
wait "$KOPF_PID" 2>/dev/null || true